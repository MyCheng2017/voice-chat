本文主要研究了如何使用Java编写语音通信的服务器，实现用户的注册和登录，语音转发等功能，以及使用Java编写基于Swing的客户端，利用JavaSound实现语音数据的采集、回放，最后利用socket使服务器和客户端进行通信，实现两个人的实时语音聊天。
This paper studies how to use Java to develop voice chat server, complete the functions of user registration and login, voice transmission and so on. And use Java to develop a chat client, use JavaSound to capture voice, playback voice and use socket to connect the chat server so that two people can chat in real time.
2.3 TCP协议
传输控制协议（Transmission Control Protocol，简称TCP）为两台计算机提供了可靠无差错的数据传输。进行TCP通讯时，在三次握手建立连接之后，信源方和数据接收方就可以用双向字节流进行数据传输。事实上TCP的数据帧也不是完全可靠的，为了实现可靠性，TCP采用了问答式传输数据，即每次发送数据后，接收计算机都会给发送方发送一个接收成功的数据帧[3]。
用户数据报协议（User Datagram Protocol，简称UDP）是一种面向无连接的通信协议。UDP具有不可靠性，但是可以向多个目标发送和接收数据。当出现网络异常等情况时，接收方计算机会收不到消息，但是发送方不会去理会对方是否收到，所以会出现数据报丢失的情况。并且接收方如果接收到了数据，也不会发送接收成功的报文给发送方。
Socket是网络上的两台计算机连接的一端，Socket连接是双向的，它的本质是对TCP/IP的封装。TCP/IP提供了Socket接口用做网络开发，Socket则提供了网络通信的能力[4]。
2.3.1 三次握手
三次握手用于建立TCP连接：
第一次握手：客户端先发送SYN包（syn=j）到服务器，并进入SYN_SENT状态，等待服务器确认。
第二次握手：服务器接收客户端发送的SYN包，然后进行确认SYN（ack=j+1），同时向客户端发送一个SYN包（syn=k），即SYN+ACK包，服务器进入SYN_RECV状态。
第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack=k+1），客户端和服务器进入ESTABLISHED状态，连接建立。
2.3.2 改进的三次握手
改进的三次握手用于关闭TCP连接：
第一步，当主机A想要结束TCP通信时，主机A先向主机B发送一个带有FIN附加标记的报文段。
第二步，主机B接收到这个FIN报文段之后，先向主机A发送一个确认序号ACK，同时通知自己相应的应用程序：对方要求关闭连接。
第三步，主机B向主机A送一个FIN报文段。
第四步，主机A收到主机B发送的FIN报文段后，向主机B发送一个ACK表示连接彻底释放。
2.5 JavaSound
JavaSound从JDK1.3.0版开始就被包含到JDK之中，支持数字音频和MIDI数据的记录和回放，是一个小巧的底层API[6]。所以使用JavaSound进行音频处理的程序在Java1.3或更高版本的系统上都能运行。
JavaSound中的Line接口提供了一些类似于调节音量大小等声音效果的对象，以及用来注册事件监听器、关闭或打开设备。音频的输入需要使用TargetDataLine接口，代表了输入设备；音频的输出需要使用SourceDataLine接口，代表了输出设备，这两个接口都继承了Line接口。AudioSystem类在JavaSound体系中起着一个工厂类的作用，通过定义了一系列的静态方法向外界提供了JavaSound系统默认配置的资源。
在处理输入音频时，对于来自CD播放器、磁带播放器、麦克风等音频输入端口的信号，通过TargetDataLine接口获得数字音频输入流。
在处理输出音频时，经处理后的信号可以写入到SourceDataLine然后再输出到扬声器、耳机等输出端口。
3.1.1 客户端功能需求
1、用户需要注册一个唯一的账号作为唯一标识，所以需要注册功能。
2、与注册对应，需要进行登录验证。
3、用户需要先与其他用户成为好友，所以需要有搜索好友、请求添加好友功能。
4、用户需要获取好友列表，才能与好友进行通信聊天，所以需要获取好友列表功能。
5、系统的主要功能是两个人之间进行语音实时通信，所以需要语音聊天功能。
6、PCM语音数据量过大，需要使用压缩编码技术进行压缩后传输，需要编解码功能。
7、为了增加软件趣味性，对语音进行添加背景，更改音调等操作。
8、拓展功能为文字聊天等。
3.1.2 服务器端功能需求
与客户端对应，需要提供以下服务。
1、注册服务。
2、登录服务。
3、搜索和添加好友服务。
4、获取好友列表服务。
5、实时语音服务。
6、文字聊天服务等。
3.4 通信协议设计
由于服务器需要完成登录、通信等功能，所以必须制定通信协议区分不同的请求类型。
所有的通信均采用byte数组进行通信，数组的第一位为数据头，第二第三位为数据长度，第四位为数据类型，第五位为校验数据，第五位后为数据位，校验采用异或校验，只校验数据头到数据类型四位，数据位不进行校验。
4.1.2 数据库连接
Java数据库连接(Java Database Connectivity，简称JDBC)是专门用来连接数据库的API，它是用Java编写的，这样就省去了Java开发人员的学习成本。JDBC提供了许多方法，Java程序可以直接调用这些方法执行SQL命令对数据库进行增删改查等操作，并且支持数据库事务操作。JDBC主要用来进行数据库连接、对数据库和数据库表进行相应地操作，即它可以执行数据库语句。它不仅可以执行一般的SQL语句还可以执行动态的SQL语句和带IN和OUT参数的存储过程，支持预编译等。使用JDBC降低了开发数据库应用的难度，开发人员只需要知道怎么使用数据库，而不必知道其内部实现，加快了开发速度，并且它支持多种数据库[14]。
为了方便使用数据库连接，首先创建JDBC的工具类JDBCUtils。在该类中首先读取配置文件中的数据库账号密码等信息，然后加载数据库驱动，再从驱动中获取数据库连接。同时，为了避免频繁的加载驱动等操作，创建了数据库连接池，封装在JDBCDataSource类中。该类是继承自DataSource类的，该类使用一个全局的LinkedList集合装载数据库连接，该类在初始化时先利用JDBCUtils工具类获取相应数量的数据库连接，然后使用单例模式向外提供数据库连接。当外部使用完连接后继续放回连接池，减少连接的过多创建。
4.2.4 音频编码
音频压缩技术是指对数字音频信号流运用数字信号处理技术在不损失有用信息量或引入损失可忽略的条件下，降低其码率，也称为压缩编码[19]。它必须具有相应的逆变换，称为解压缩或解码。
1、ADPCM编码
ADPCM算法利用了语音信号样点间的相关性，并针对语音信号的非平稳特点，使用了自适应预测和自适应量化，即量化器和预测器的参数能随输入信号的统计特性自适应于或接近于最佳的参数状态[20]。通过此算法可将样点编码成4bit的码流，一个符号位和三个幅度位，压缩比是4:1。
本软件首先对音频的幅度进行分析，幅度过小的声音人耳听不见或者不敏感，并且人和人在使用语言进行交流时，很大部分自己是不说话的，而是在倾听对方说话，所以对于幅度过小或者幅度为零的语音数据就不需要传送。幅度过滤后采用ADPCM进行编码后传送，实现数据的压缩，对方接收后进行相应的解压然后再播放。
4.2.5 变声
无论是硬件变声器，还是软件变声器，其原理都是通过改变输入声音频率，进而改变声音的音色、音调，使输出声音在感官上与原声音不同[21]。本软件使用重采样进行变声。
假设重采样因子为P/Q，其中，P为上采样因子，Q为下采样因子。上采样过程就是往原始信号相邻两点间内插P-1个采样点，这样使得基音周期变为原来的P倍，频谱压缩为原来的1/P倍，时长变为原来的P倍，即基频变为原来的1/P倍，音调降为原来的1/P倍，语速变为原来的1/P倍。
同样地，下采样过程就是每隔Q-1个点进行抽取，这样会使得基音周期长度为原来的1/Q倍，频谱扩展为原来的Q倍，时长变为原来的1/Q倍，即基频变为原来的Q倍，音调升为原来的Q倍，语速变为原来的Q倍。
4.2.6 混音
声音是物体振动对周围的空气产生压力的压力波，转成电信号并经过抽样、量化后仍连续平滑的波形信号。量化后的信号频率与声音频率对应，振幅与音量对应。量化的语音信号的叠加等于空气中声波的叠加，所以当各信号的采样率一致时，混音可以实现为将各信号的采样数据线性叠加[22]。
混音的应用可以为声音添加背景音乐，比如鸟叫、街道、乐曲等，混音也是实现多人语音聊天室的主要技术之一。

总结
即时通信软件的出现不仅丰富了人们的日常生活，还缩短了人与人之间的距离，降低了人们长距离通讯的成本。现如今，人们已经很难离开即时通信而生活了，因为它活跃在我们的工作和生活中，也早已根深蒂固了。
本文从理论到实践，详细地阐述了基于Java的语音通信软件的实现过程。在服务器的实现中，使用JDBC实现了对数据库数据进行增删改查，使用多线程技术实现了数据库连接池，使用JavaMail实现了邮件发送，而与客户端进行字节流通信使用了Socket技术。在客户端的实现中，使用Swing制作了客户端的交互界面，使用JavaSound实现了语音的采集和回放，使用接口回调的方法实现界面的更新和切换，使用ADPCM编码实现了对音频数据的压缩与解压缩，使用重采样的技术实现了语音变调的效果，使用线性叠加实现了混音功能，为多人语音聊天室奠定了基础。
本系统还存在着许多不足之处。一是由于数字信号处理的书籍囊括了实际工程中的各个方面，虽然查找了很多数字信号处理的资料，但是本人的理解不到位，很难运用到实际当中，导致在语音处理时只使用了简单的ADPCM等进行语音处理，语音变声的处理也不是很理想。二是由于时间紧迫，只实现了登录、注册、文字聊天、表情发送、语音聊天、语音压缩、语音变声、添加背景音等功能，比微信等聊天工具的功能少很多，并且可能存在一些未被发现的Bug和错误等。
